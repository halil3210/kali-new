// F√úGE DIESEN CODE IN /opt/klcp-auth-server/authRoutes.js EIN,
// VOR DER LETZTEN ZEILE MIT "module.exports = router;"

// Google Sign-In endpoint
router.post('/google-signin', async (req, res) => {
  try {
    const { idToken, email, displayName } = req.body;
    
    if (!idToken || !email) {
      return res.status(400).json({ error: 'ID Token and email required' });
    }

    console.log('üîµ Google Sign-In attempt for:', email);

    // Check if user exists
    const existingUser = await runQuery('SELECT * FROM users WHERE email = ?', [email]);

    let user;
    if (existingUser) {
      // Update last login and mark as verified
      await runQuery('UPDATE users SET last_login = ?, is_verified = 1 WHERE id = ?', 
                    [Date.now(), existingUser.id]);
      user = existingUser;
      console.log('üîÑ Existing Google user updated:', email);
    } else {
      // Create new user (Google users are automatically verified)
      const userId = uuidv4();
      const result = await runQuery(
        'INSERT INTO users (id, email, password, is_verified, created_at, last_login) VALUES (?, ?, ?, 1, ?, ?)',
        [userId, email, 'GOOGLE_USER', Date.now(), Date.now()]
      );
      
      user = {
        id: userId,
        email: email,
        is_verified: 1
      };
      console.log('üÜï New Google user created:', email);
    }

    // Generate JWT token
    const jwt = require('jsonwebtoken');
    const JWT_SECRET = process.env.JWT_SECRET || 'klcp-super-secret-key-2025';
    const token = jwt.sign(
      { 
        userId: user.id, 
        email: user.email 
      },
      JWT_SECRET,
      { expiresIn: '30d' }
    );

    console.log('‚úÖ Google Sign-In successful for:', email);

    res.json({
      message: 'Google Sign-In successful',
      token: token,
      userId: user.id,
      email: user.email,
      isVerified: !!user.is_verified  // Ensure boolean
    });

  } catch (error) {
    console.error('‚ùå Google Sign-In error:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// ENDE DES GOOGLE SIGN-IN CODES

